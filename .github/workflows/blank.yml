name: Rancher-Darkside-Collector-V7-ZIP-ONLY
on: [workflow_dispatch]

jobs:
  collect-assets:
    runs-on: ubuntu-latest
    steps:
      - name: Create Workspace
        run: mkdir -p darkside-kit/extensions

      - name: Fetch UI Extension (Le fichier vital)
        run: |
          cd darkside-kit/extensions
          echo "Téléchargement de l'extension Harvester UI..."
          # On télécharge l'archive complète du site web de l'extension
          curl -L https://github.com/harvester/harvester-ui-extension/archive/refs/heads/gh-pages.zip -o harvester-ui.zip

      - name: Image Extraction (Uniquement le nécessaire)
        run: |
          cd darkside-kit
          # On ne met QUE ce qui existe vraiment.
          # Le reloader (pour sécuriser ton monitoring)
          echo "docker.io/rancher/mirrored-prometheus-operator-prometheus-config-reloader:v0.72.0" > image_list.txt
          # Nginx (toujours utile pour servir des fichiers si besoin)
          echo "docker.io/library/nginx:alpine" >> image_list.txt

      - name: Pull and Save Images
        run: |
          cd darkside-kit
          # On télécharge les images
          while IFS= read -r img; do
            docker pull "$img" || echo "Skip $img"
          done < image_list.txt
          
          # On sauvegarde
          docker save -o images-darkside.tar $(cat image_list.txt)
          gzip -9 images-darkside.tar

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rancher-harvester-kit-V7
          path: darkside-kit/
