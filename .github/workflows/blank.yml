name: Rancher-Darkside-Collector
on: [workflow_dispatch]

jobs:
  collect-assets:
    runs-on: ubuntu-latest
    steps:
      - name: Create Workspace
        run: mkdir -p darkside-kit/charts

      - name: Fetch Helm Charts
        run: |
          cd darkside-kit/charts
          helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
          helm repo add rancher-charts https://charts.rancher.io
          helm repo update
          
          # Versions cibles pour Rancher 2.10
          helm pull rancher-stable/rancher --version 2.10.2
          helm pull rancher-charts/rancher-monitoring-crd --version 104.1.0+up57.0.3
          helm pull rancher-charts/rancher-monitoring --version 104.1.0+up57.0.3

      - name: Deep Image Extraction
        run: |
          cd darkside-kit
          # Analyse profonde des templates ET des fichiers values.yaml
          helm template charts/rancher-monitoring-*.tgz --include-crds > full_template.yaml
          helm show values charts/rancher-monitoring-*.tgz >> full_template.yaml
          
          # Extraction propre des images (format: repo/image:tag)
          grep -E "image:|repository:|tag:" full_template.yaml | grep -v "null" | \
          sed -e 's/image://g' -e 's/repository://g' -e 's/tag://g' -e 's/"//g' -e "s/'//g" -e 's/^[ \t]*//' | \
          grep "/" | sort | uniq > image_list.txt
          
          echo "=== Liste des images à télécharger ==="
          cat image_list.txt

      - name: Pull and Save Images
        run: |
          cd darkside-kit
          while IFS= read -r img; do
            # Gestion des images sans tag explicite
            [[ "$img" != *:* ]] && img="$img:latest"
            echo "Processing: $img"
            docker pull "$img" || continue
          done < image_list.txt
          
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "none" > final_images.txt
          xargs docker save -o images-monitoring.tar < final_images.txt
          gzip images-monitoring.tar

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: darkside-rancher-kit
          path: darkside-kit/
