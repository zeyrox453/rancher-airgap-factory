name: Rancher-Darkside-Collector-V4
on: [workflow_dispatch]

jobs:
  collect-assets:
    runs-on: ubuntu-latest
    steps:
      - name: Create Workspace
        run: mkdir -p darkside-kit/charts

      - name: Fetch Helm Charts
        run: |
          cd darkside-kit/charts
          helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
          helm repo add rancher-charts https://charts.rancher.io
          helm repo update
          
          helm pull rancher-stable/rancher --version 2.10.2
          helm pull rancher-charts/rancher-monitoring-crd --version 104.1.0+up57.0.3
          helm pull rancher-charts/rancher-monitoring --version 104.1.0+up57.0.3

      - name: Deep Image Extraction & Force Injection
        run: |
          cd darkside-kit
          # Analyse profonde des templates
          helm template extraction charts/rancher-monitoring-104.1.0+up57.0.3.tgz \
            --include-crds \
            --kube-version 1.31.0 > full_template.yaml
          
          # Extraction des images par défaut dans les valeurs (reloader, etc.)
          helm show values charts/rancher-monitoring-104.1.0+up57.0.3.tgz >> full_template.yaml

          # Capture automatique
          grep -E "image:|repository:|tag:" full_template.yaml | grep -v "null" | \
          awk '{print $2}' | tr -d '"' | tr -d "'" | sed 's/^[ \t]*//' | \
          grep "/" | sort | uniq > image_list.txt

          # === FORCE INJECTION (La sécurité pour le Darkside) ===
          # On ajoute manuellement les images critiques qui sont souvent invisibles au template
          echo "docker.io/rancher/mirrored-prometheus-operator-prometheus-config-reloader:v0.72.0" >> image_list.txt
          echo "docker.io/rancher/mirrored-prometheus-prometheus:v2.50.1" >> image_list.txt
          echo "docker.io/rancher/mirrored-prometheus-alertmanager:v0.27.0" >> image_list.txt
          echo "docker.io/rancher/mirrored-library-nginx:1.24.0-alpine" >> image_list.txt
          
          sort -u image_list.txt -o image_list.txt
          echo "=== Liste finale des images (incluant injections) ==="
          cat image_list.txt

      - name: Pull and Save Images
        run: |
          cd darkside-kit
          mkdir images
          while IFS= read -r img; do
            [[ "$img" != *:* ]] && img="$img:latest"
            echo "Pulling: $img"
            docker pull "$img" || echo "Skip $img"
          done < image_list.txt
          
          # On sauvegarde tout dans un seul gros tar.gz
          docker images --format "{{.Repository}}:{{.Tag}}" | grep "rancher" > final_images.txt
          xargs docker save -o images-darkside.tar < final_images.txt
          gzip -9 images-darkside.tar

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rancher-monitoring-kit-V4
          path: darkside-kit/
          retention-days: 1
