name: Rancher-Darkside-Collector-V2
on: [workflow_dispatch]

jobs:
  collect-assets:
    runs-on: ubuntu-latest
    steps:
      - name: Create Workspace
        run: mkdir -p darkside-kit/charts

      - name: Fetch Helm Charts
        run: |
          cd darkside-kit/charts
          helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
          helm repo add rancher-charts https://charts.rancher.io
          helm repo update
          
          # On télécharge les versions spécifiques
          helm pull rancher-stable/rancher --version 2.10.2
          helm pull rancher-charts/rancher-monitoring-crd --version 104.1.0+up57.0.3
          helm pull rancher-charts/rancher-monitoring --version 104.1.0+up57.0.3

      - name: Deep Image Extraction
        run: |
          cd darkside-kit
          # FIX : On ajoute "extraction" comme nom de release pour éviter l'erreur de regex
          echo "Analyse du chart Monitoring..."
          helm template extraction charts/rancher-monitoring-104.1.0+up57.0.3.tgz --include-crds > full_template.yaml
          helm show values charts/rancher-monitoring-104.1.0+up57.0.3.tgz >> full_template.yaml
          
          echo "Analyse du chart Rancher..."
          helm template extraction-rancher charts/rancher-2.10.2.tgz >> full_template.yaml

          # Extraction des images (format propre)
          grep -E "image:|repository:" full_template.yaml | grep -v "null" | \
          awk '{print $2}' | tr -d '"' | tr -d "'" | sed 's/^[ \t]*//' | \
          grep "/" | sort | uniq > image_list.txt
          
          echo "=== Images détectées ==="
          cat image_list.txt

      - name: Pull and Save Images
        run: |
          cd darkside-kit
          # On pull chaque image trouvée
          while IFS= read -r img; do
            [[ "$img" != *:* ]] && img="$img:latest"
            echo "Pulling: $img"
            docker pull "$img" || echo "Skip $img (non trouvé)"
          done < image_list.txt
          
          # Sauvegarde massive dans un seul tar
          echo "Sauvegarde des images..."
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "none" > final_images.txt
          xargs docker save -o images-darkside.tar < final_images.txt
          gzip images-darkside.tar

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rancher-monitoring-kit
          path: darkside-kit/
          retention-days: 1
