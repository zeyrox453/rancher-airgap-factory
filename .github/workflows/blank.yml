name: Rancher Airgap Kit - Charts & Images Fix

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare Workspace
        run: mkdir -p rancher-kit

      # CORRECTION ICI : Utilisation de HELM pour télécharger les charts
      # C'est plus fiable que wget car Helm trouve le bon lien tout seul
      - name: Download Charts with Helm
        run: |
          cd rancher-kit
          
          # 1. On ajoute les dépôts officiels Rancher
          helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
          helm repo add rancher-charts https://charts.rancher.io
          helm repo update

          # 2. Téléchargement Rancher (Upgrade)
          echo "Téléchargement Chart Rancher..."
          helm pull rancher-stable/rancher --version 2.10.3

          # 3. Téléchargement Monitoring (On prend la 104.1.0 qui est très stable)
          # Helm va télécharger le .tgz tout seul
          echo "Téléchargement Charts Monitoring..."
          helm pull rancher-charts/rancher-monitoring --version 104.1.0+up57.0.3
          helm pull rancher-charts/rancher-monitoring-crd --version 104.1.0+up57.0.3

      - name: Pull Docker Images
        run: |
          # --- RANCHER CORE ---
          docker pull rancher/rancher:v2.10.3
          docker pull rancher/rancher-agent:v2.10.3
          docker pull rancher/rancher-webhook:v0.5.2
          docker pull rancher/shell:v0.3.0
          docker pull rancher/fleet-agent:v0.11.3
          docker pull rancher/fleet:v0.11.3
          docker pull rancher/system-upgrade-controller:v0.14.2
          
          # --- MONITORING STACK ---
          # (Images alignées avec le chart 104.1.0)
          docker pull registry.k8s.io/prometheus-adapter/prometheus-adapter:v0.12.0
          docker pull rancher/mirrored-prometheus-alertmanager:v0.27.0
          docker pull rancher/mirrored-prometheus-node-exporter:v1.8.1
          docker pull rancher/mirrored-kube-state-metrics-kube-state-metrics:v2.13.0
          docker pull rancher/mirrored-prom-prometheus:v2.54.1
          docker pull rancher/mirrored-grafana-grafana:11.1.0
          docker pull rancher/mirrored-prometheus-operator-prometheus-operator:v0.76.2
          docker pull rancher/mirrored-prometheus-operator-prometheus-config-reloader:v0.76.2
          docker pull rancher/mirrored-ingress-nginx-kube-webhook-certgen:v1.4.3
          docker pull rancher/pushprox-client:v0.1.0
          
          # --- STOCKAGE ---
          docker pull registry.k8s.io/sig-storage/csi-provisioner:v5.0.1
          docker pull registry.k8s.io/sig-storage/csi-resizer:v1.11.1
          docker pull registry.k8s.io/sig-storage/csi-snapshotter:v8.0.1
          
      - name: Save Images to Tar
        run: |
          docker save \
            rancher/rancher:v2.10.3 \
            rancher/rancher-agent:v2.10.3 \
            rancher/rancher-webhook:v0.5.2 \
            rancher/shell:v0.3.0 \
            rancher/fleet-agent:v0.11.3 \
            rancher/fleet:v0.11.3 \
            rancher/system-upgrade-controller:v0.14.2 \
            registry.k8s.io/prometheus-adapter/prometheus-adapter:v0.12.0 \
            rancher/mirrored-prometheus-alertmanager:v0.27.0 \
            rancher/mirrored-prometheus-node-exporter:v1.8.1 \
            rancher/mirrored-kube-state-metrics-kube-state-metrics:v2.13.0 \
            rancher/mirrored-prom-prometheus:v2.54.1 \
            rancher/mirrored-grafana-grafana:11.1.0 \
            rancher/mirrored-prometheus-operator-prometheus-operator:v0.76.2 \
            rancher/mirrored-prometheus-operator-prometheus-config-reloader:v0.76.2 \
            rancher/mirrored-ingress-nginx-kube-webhook-certgen:v1.4.3 \
            rancher/pushprox-client:v0.1.0 \
            registry.k8s.io/sig-storage/csi-provisioner:v5.0.1 \
            registry.k8s.io/sig-storage/csi-resizer:v1.11.1 \
            registry.k8s.io/sig-storage/csi-snapshotter:v8.0.1 \
            -o rancher-kit/images.tar

      - name: Compress Archive
        run: gzip rancher-kit/images.tar

      - name: Export Full Airgap Kit
        uses: actions/upload-artifact@v4
        with:
          name: rancher-upgrade-kit-2.10
          path: rancher-kit/
          retention-days: 1
